% !TEX root = ./MParticle.tex
\section{Relaxation of the Max Pressure Controller. Stability of the new Controller} \label{sec:immediatefeedback}




%%%%%%%%%
%relaxation of the controller
%%%%%%%%%
 

%%%%%%%%%%%
%Physically, one could consider one model time step to represent an entire light cycle, during which each signal phase will be sequentially actuated for some proportional amount of the period. (Although this would suggest a serial division of the time period between independent phases rather than the parallel implementation that is represented here mathematically.) 
%%%%%%%%%%%


We reformulate the controller so as to fullfill those guarantees. 
Then we show that a similar stability result as the one shown by Varaiya holds (under some \emph{slightly} weaker conditions).
To fulfill the first condition, we allow the control to be a convex combination of the different possible control matrices.
For the second condition we consider a control that is not updated every time steps.
The final control that we choose is a combination of the two.







%%%%%%%%%%%%%%%%%%%%%%%%%%%
%distributed max pressure
%%%%%%%%%%%%%%%%%%%%%%%%%%%
 




\subsection*{Phase distribution within a cycle}
We next investigate how the max pressure controller must be altered to allow the minimum proportion constraints on each phase in the set of allowable phases $\mathcal U$.

Let $T$ be the cycle length satisfying \eqref{minTime} and $\kappa_S$ be the minimum proportion of the cycle which must be allocated to each $S\in U$. %By definition, our controller must therefore satisfy the following condition:
%\begin{equation}
%T = (\sum_{S \in \mathcal U } \lambda_{S})T+ L
%\end{equation}
The allocated max pressure controller selects a set of $\lambda_S$ that maximizes alleviated pressure under the following constraints:
\begin{itemize}
\item $\lambda_{S} \geq \kappa_S$ 
\item $f_{l}r_{l,m} < \sum_{S}\lambda_{S} c(l,m)S(l,m)$
\item $ \sum_{S} \lambda_{S} = 1 - \frac{L}{T}$
\end{itemize}
%We therefore formulate the following convex optimization problem: 
%\begin{equation*}
%\begin{aligned}
%& \underset{\lambda_{1},...,\lambda_{\vert U\vert}}{\text{maximize}}
%& & \displaystyle\displaystyle\sum_{l,m} w(l,m)(t)c(l,m)(\displaystyle\sum_{S \in \mathcal{U}}\lambda_{S}S(l,m))  \\
%& \text{subject to}
%& &  \lambda_{S} \geq \kappa_S \\
%&&& \displaystyle\sum_{S} \lambda_{S} \leq 1 - \dfrac{L}{T}
%\end{aligned}
%\end{equation*}
The desired controller is therefore determined by the solution to the following linear program: 
\begin{align} \nonumber
\{ \lambda^*_S \} = \; & \underset{\lambda_{1},...,\lambda_{\vert U\vert}}{ \arg \max} & & \sum_{S \in \mathcal{U}}\lambda_{S}\Big(\sum_{l,m} w(l,m)(t)c(l,m) S(l,m)\Big)  \\
\nonumber & \text{subject to}
\nonumber & &  \lambda_{S} \geq \kappa_s\\
&&&\sum_{S} \lambda_{S} \leq 1 - \tfrac{L}{T}  \label{distMP_LP}
\end{align}



The solution to \eqref{distMP_LP} selects coefficients $\{ \lambda_{S}^{*} \} $ which form a corresponding relaxed control
matrix \begin{equation} S^{r*} = \displaystyle\sum_{S \in \mathcal{U}}\lambda_{S}^{*}S\end{equation}




\subsection*{Cycle max pressure}

Cycle max pressure enables the control to act at a slower time scale than the queue dynamics, as would be the case in a practical traffic application. Suppose that we are given the model dynamics $X(t)$ as in \eqref{entrydynamics}-\eqref{internaldynamics}, but the controller $S^*(t)$ can only be updated every $\tau$ model time steps (or once per \emph{cycle}). The ``$\tau$-non updated'' control sequence is therefore composed of control matrices repeated for at least $\tau$ model time steps: for a fixed cycle size $\tau$ and integer $n$, 
\begin{align} \nonumber
S(n\tau&+1)  = S(n\tau +2) = \ldots = S((n+1)\tau ) = S^*(n\tau +1) \\
&=  \arg\max\{\gamma(S)(X(n\tau +1 )) \vert S \in U\}  
 \label{CYCLE_CONTROLLER}
\end{align}
Physically, the controller that maximizes the pressure at time step $n\tau + 1$ is continuously applied until time step $(n + 1)\tau$.

\subsection*{Relaxed Max Pressure Controller}

Let $\tau \in \mathbb{N}$ be fixed, the number of time steps between two actuation of the controller
$\forall n \in \mathbb{N}$, 

\begin{align} \nonumber
S(n\tau&+1)   = \ldots = S((n+1)\tau ) = S^*(n\tau +1) \\
&=  \arg\max\{\gamma(S)(X(n\tau +1 )) \vert S \in U\}  \\
& =  \underset{\lambda_{1},...,\lambda_{\vert U\vert}}{ \arg \max}  \sum_{S \in \mathcal{U}}\lambda_{S}\Big(\sum_{l,m} w(l,m)(t)c(l,m) S(l,m)\Big)  \\
\nonumber  & \text{subject to}\\
\nonumber  &  \lambda_{S} \geq \kappa_s\\
& \sum_{S} \lambda_{S} \leq 1 - \tfrac{L}{T}  \label{distMP_LP}\\
& = S^{r*} \\
&= \displaystyle\sum_{S \in \mathcal{U}}\lambda_{S}^{*}S
\end{align}


\subsection*{Minimum cycle time}
Consider that the length $T$ of the controller update time period (signal cycle) is not pre-defined. However, there is a known amount of \emph{lost time} $L$ per cycle during which no phases can be actuated to account for physical clearance of the intersection between actuated phases. Hence it must be the case that $T>L$.  We furthermore impose that each feasible phase has an associated minimum proportion constraint: phase $S$ must be actuated for at least $\lambda_S T$ seconds during any one cycle. We then want to determine the minimum control period or \emph{cycle length} for which a fixed demand flow can be served while the stated phase proportion constraints are satisfied. 

Unlike the previous case where we constrained our analysis to flows which could be served in average over an arbitrary long-term time horizon, here our proof of stability depends on the assumption that the average demand is served \textit{within a single cycle}. As suggested in \cite{MaxPressureStochastic}, we then pose the selection of a cycle length as a convex optimization problem with constraints applied to enforce the desired minimum phase proportions $\kappa$:
\begin{equation} \label{sum_lambda}
\begin{aligned}
& \underset{\lambda = (\lambda_{S})_{S}}{\text{minimize}}
& & \sum_{S\in U} \lambda_{S} \\
& \text{subject to}
& &  \lambda_{S} \geq \kappa_S\\
&&& f_{l}r(l,m) < \sum_{S}\lambda_{S} c(l,m)S(l,m)\\
%&&& \sum_{S} \lambda_{S} < 1
\end{aligned}
\end{equation}
where $\kappa_S \in [0,1] \; \forall S\in U$, and $\sum_S \kappa_S <1$. 
%
%This is an obvious extension of the the linear program for a single intersection proposed by Allsop \cite{Allsop} and an implicit version of the formulation of Wong and Yang \cite{Wong}

Let us denote $\Lambda^{*}$ to be the optimum of  \eqref{sum_lambda}. If $\Lambda^* > 1$, the demand is not feasible under the set of control constraints $\{\kappa_S\}$ for any length time step. If $\Lambda^* < 1$, then the flow is admissible for a time step of length 
\begin{equation} T > \frac{L}{1-\Lambda^*} \label{minTime} \end{equation} 
We can now use this lower bound to select an appropriate cycle length. 


\subsection*{$\tau$-admissible flows}
We first prove that this set of $\tau$-admissible flows (demands that can be accommodated using $\tau$-non updated sequences) is in fact the same set of flows that is admissible under typical updated control sequences, defined in equation \eqref{feasible_demand}. 

\noindent Define the following sets:
\begin{itemize}
\item $U$ is the set of admissible control matrices as in \eqref{feasible_demand},
\item $U_{\mathbb{N}}$ is the set of control sequences $\{S(1), S(2) \ldots S(t) \ldots |  S(\cdot) \in U\} $ where elements are applied at consecutive time steps,
\item $U_{\tau\mathbb{N}}$ is the set of control sequences $\{S(1), S(1), \ldots ,  S(\tau + 1),S(\tau + 1), \ldots , S(n\tau + 1),S(n\tau + 1), \ldots |  S(\cdot) \in U\} $ where controls are updated only once every $\tau$ steps,
\item $conv(U) = \Big\{\lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t) | \{S(1), S(2), \ldots , \\ S(t), \ldots \}\in U_{\mathbb{N}} \Big\} $ 
\item $conv(U_\tau ) = \Big\{\lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t) | \{S(1), S(1), \ldots, \\ S(\tau + 1),S(\tau + 1), \ldots\}\in U_{\tau\mathbb{N}} \Big\} $ 
\end{itemize}
Obviously, $conv(U_{\tau}) \subset conv(U)$. But we can also show that $conv(U) \subset conv(U_{\tau})$:  

\noindent Suppose $M \in conv(U)$, so $\exists \{ S(1) \ldots S(t) \ldots \}$ such that $M = \lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t)$.
\begin{align*}
M &= \lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t)= \lim\inf_{T} \dfrac{1}{\tau T}\sum_{t=1}^{\tau T}  \tilde{S}(t) \; \\ 
& \qquad \text{ with } \tilde{S} = \{S(1), \ldots, S(1), \ldots, S(t), \ldots, S(t), \ldots \} \\
&= \lim\inf_{T} \dfrac{1}{ T}\sum_{t=1}^{T}  \tilde{S}(t) \\
\end{align*}
Trivially, $\tilde{S }\in conv(U_\tau)$. Because $conv(U_{\tau})\subset conv(U)$ and $cont(U) \subset conv(U_{\tau})$, it must hold that $conv(U) = conv(U_{\tau})$.  This establishes Property \ref{equality_property}: 

\begin{Prop} \label{equality_property}
\begin{equation*} conv(U) = conv(U_{\tau}) \end{equation*}
\end{Prop}

This property implies that a $\tau$-non updated control sequence can accommodate the same set of flows as a control sequence updated at every time step. The equivalence becomes intuitive when one considers that our definition of feasible flows considers only the long-term average of demand and service rates: note that a $\tau$ control matrix in $\tilde S$ is simply the average of the corresponding $\tau$ matrices in $\overline S$, such that $M_{\tilde S} = M_{\overline S}$. Hence,
\begin{align}
f_{l} r(l,m) < c(l,m)M_{\overline{S} }(l,m) \implies \\ f_{l} r(l,m) < c(l,m)M_{\tilde{S} }(l,m). \nonumber
\end{align}
However, as we will show in the following sections, the bound on queue lengths when the cycle controller is applied will be larger than in the immediate feedback setting.
%, which immediately seems counterintuitive. However, note that our current model framework assumes infinite link buffer capacities. With the $\tau$-non updated controller, instantaneous link queues will be higher but the same \emph{long-term average} service rates can be achieved -- and thus by our definition, this flow can be equally accommodated by either controller type. 
%We have shown that the same flows are ``admissible'' when control sequences updated only every $\tau$ time steps as when they are updated every time step. 
%During a single time step, the average flow arriving at queue $(l,m)$ is $f_{l}r(l,m)$ and the maximum number of vehicles capable of leaving is $c(l,m) M(l,m)$. Similarly, the average flow arriving between time steps $t$ and $t+\tau$ is $\tau f_{l} r(l,m) $, and the number of vehicles capable of leaving is $\tau c(l,m) M(l,m)$. So if a flow is admissible using an updated control sequence $\overline S$%with average service $M_{\overline S}$
%, it can be similarly accommodated with a non-updated sequence $\tilde S$, where each consecutive set of






\subsection*{Stability of the new controller}



Here we extend the previous proof of stability of an immediate feedback max pressure controller to the case of our relaxed max pressure controller.
We begin by defining two sets we gonna use later.

Define $conv_{\kappa}$ as the set of convex combinations of control matrices with coefficients larger than $\kappa$:
\begin{equation}
conv_{\kappa} = \Big\{ \sum_{S}\lambda_{S}S \big| \; \lambda_S > \kappa_S \; \forall S\in U\Big\}
\end{equation}
Also define a set of reduced admissible demands $D_{\kappa}$ which can in average be served in a single cycle with a relaxed control matrix that maintains the minimum time allocation for a given cycle time (as in \eqref{sum_lambda}):
\begin{align} \nonumber
d \in D_{\kappa} \; & \text{iff} \; \exists \; S^r \in conv_{\kappa} \; \\ & \text{such that} \; f_{l}r(l,m) < c(l,m)S^r(l,m)
\label{admissible_relaxed}
\end{align} 

\vspace{0.5cm}


\begin{Thm}\label{stabRelaxMP}
The relaxed max pressure controller, defined above, updated every $\tau$ iterations stabilizes the network whenever the demand is within a set of feasible demands $D^{\kappa}$.
\end{Thm}

\begin{proof}



%
%\subsubsection*{Immediate feedback Max Pressure: proof of Theorem 3}
%\input{appendix_immediatefeedbackproof}
\subsubsection*{Allocated Max Pressure: proof of Theorem 6}
\input{appendix_distributedproof}
\subsubsection*{Cycle Max Pressure: proof of Theorem 5}
\input{appendix_cycleproof}



\begin{align} \label{CYCLE_BOUNDS}
\dfrac{1}{\tau T} \displaystyle\sum_{t=1}^{\tau T} \expectation{\vert X(t)}< \dfrac{1}{2\varepsilon\eta\tau T}& \expectation{\vert X(1) \vert^{2}} \\ \nonumber
& + \dfrac{1}{2\varepsilon\eta\tau}\displaystyle\sum_{p=0}^{\tau - 1} (B(p) + \tau K)
\end{align}

where $\varepsilon$, $\eta$ and $K$ are constants which depend on network topology and demand.

\end{proof}

The proof above shows that the system is stable.




\subsection*{Stability of allocated max pressure}

We now show that the allocated max pressure controller $S^{r*}$ is stable in the sense of \eqref{stability_sufficient} under conditions slightly modified from those assumed in the stability proofs of immediate feedback and cycle max pressure.



%%%%%%%%%%%%%%%%%%%%%%%%
%cycle allocated MP
%%%%%%%%%%%%%%%%%%%%%%%%


%\subsection*{Definition}
%
%We now combine the cycle max pressure and allocated max pressure: once every $\tau$ model time steps, a relaxed controller $S^r$ is chosen and then applied at each of the subsequent $\tau$ time steps. In other words, a single relaxed controller $S^r(t)$ is applied for the set of time steps $\{t+1, t+2, \ldots, t+\tau -1 \}$. Then, at time $t+\tau$, a new relaxed controller $S^r (\tau)$ is calculated to be applied at $\{t+\tau+1, \ldots, t+2\tau -1 \}$. 
%
%\subsection*{Stability of cycle-allocated max pressure}
%\begin{Thm}\label{StabCycleDistributedMP}
%The sequence of cycle-allocated max pressure controller stabilizes the network
% whenever the average demand vector $d = \lbrace d_{l}\rbrace$ is within the set of feasible demands
%$ D_{\kappa}$ defined above.
%%Under this condition, the quantity:
%%\begin{equation}
%%\dfrac{1}{T}\sum_{t=1}^{T}\expectation{\vert X(t) \vert}
%%\end{equation}
%%is bounded for any time horizon $T$.
%\end{Thm}
%
%\vspace{0.5cm}
%
%The stability of the cycle-allocated max pressure control follows from a logical combination of the stability proofs of cycle and allocated variations. Explicitly, the result for cycle max pressure in Appendix \ref{cycleproof} still holds in the case of a relaxed controller when one assumes that demand flow satisfies the modified cycle-by-cycle admissibility condition introduced for allocated max pressure in Section \ref{sec:distributed}. 



\subsection*{Increased bound on queue length}
Max pressure controllers that are only updated every $\tau$ model time steps will stabilize a network; however the resulting bound on the queues will be higher than in the immediate feedback setting. 
Comparing \eqref{IF_BOUNDS} and \eqref{CYCLE_BOUNDS}, note that the constants are increased by a factor of
\begin{equation}
\dfrac{1}{\varepsilon \tau} \sum_{p=1}^{\tau - 1} B(p) = \dfrac{1}{\varepsilon \tau}  \dfrac{\tau(\tau - 1)}{2}\cdot(\text{constant}) = \dfrac{\tau - 1}{2\varepsilon} \cdot(\text{constant})
\end{equation}
The relative cost to queue bounds is therefore linear in $\tau$. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%










