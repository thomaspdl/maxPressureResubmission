% !TEX root = ./MParticle_resubmit.tex
\section{Cycle-based Max Pressure Controller} 




%%%%%%%%%
%relaxation of the controller
%%%%%%%%%
 

%%%%%%%%%%%
%Physically, one could consider one model time step to represent an entire light cycle, during which each signal phase will be sequentially actuated for some proportional amount of the period. (Although this would suggest a serial division of the time period between independent phases rather than the parallel implementation that is represented here mathematically.) 
%%%%%%%%%%%


The attractive qualities of max pressure for controlling vehicular traffic in urban road networks are presented in \cite{MaxPressureStochastic}. Yet as previously discussed, this original formulation of the controller is not practical for application on a signalized traffic network for three reasons:
\begin{enumerate}[a)]
\item it does not account for capacity reductions (lost time) due to excessive signal switching, 
\item it cannot enforce coordination between subsequent intersections for purposes of maximizing flow continuity, and
\item it does not provide guarantees that low-demand queues will be served within a finite time period. 
\end{enumerate} 
These limitations motivate our extension of the standard immediate feedback max pressure control algorithm. In the following section, we define a new \emph{cycle-based} max pressure controller which bounds the number of signal switches per fixed time period, provides capacity for standard signal coordination methods, and can easily guarantee a minimum service rate for all intersection phases. We then show that the application of this controller yields a similar stability guarantee to that shown by Varaiya for the standard controller given slightly weaker conditions on demand flow. The structure of this proof is as follows: 
\begin{enumerate}[i.]
\item First, we formalize a calculation of the \emph{lost time} incurred by signal switching actions. 
\item Then we introduce a formulation of the cycle-based max pressure algorithm and briefly describe how it inherently rectifies issues a), b), and c) above. 
\item Next, we introduce the concept of a \emph{$\tau$-non updated} controller that can only be updated once every $\tau$ model time steps (or once per \emph{cycle}), and we show that queue stability holds with such a controller given slightly stricter conditions on demand flows. 
\item We finally show that this result does not change if the $\tau$-non updated controller is a relaxed controller as defined in \eqref{relaxed1}-\eqref{relaxed2}. 
\end{enumerate}
The last three arguments combine to prove that the cycle-based max pressure controller stabilizes a vertical queueing network. 

%
%To fulfill the first condition, we allow the control to be a convex combination of the different possible control matrices.
%For the second condition we consider a control that is not updated every time steps.
%The final control that we choose is a combination of the two.



%%%%%%%%%%%%%%%%%%%%%%%%%%%
%distributed max pressure
%%%%%%%%%%%%%%%%%%%%%%%%%%%
 
\subsection*{Lost time due to switching}
For safety reasons, an intersection controller cannot switch signal phase actuation immediately. Instead, it must incorporate a pause of $R\approx2.5$ seconds in which all signal phases have a red light. This \emph{clearance time} allows all vehicles in the previously actuated phase to clear the intersection before a conflicting phase can be permitted to use the intersection. 

In the standard formulation of max pressure, the controller chooses an appropriate action based feedback received at every time step of the modeled dynamics. To accurately capture queuing behaviors observed on arterial roadways, a model would need to operate with a time discretization of $\Delta t< 10$ seconds. A signal switch at every time step could therefore result in more than 25\% loss of intersection service capacity, which is not considered in the theoretical examination presented in \cite{MaxPressureStochastic}. 

In this work, we explicitly fix the number of signal switches that can occur in a fixed number of model time steps using the familiar concept of a \emph{signal cycle}. As typical with modern traffic signals, the \emph{cycle-based} max pressure controller rotates through all available signal movements within a fixed time period. We define \emph{cycle time} $T$ as a fixed number of model time steps and require that each controller phase $S$ must be green for some proportion $\lambda_S > \kappa_S$ of the $T$ steps, where the \emph{minimum green splits} $\kappa_S \in (0,1) \; \forall \; S \in U $ are parameters selected by a network manager.  

The selection of a cycle time $T$ intuitively affects intersection capacity. Our proof of network stability in the following sections relies on the fact that road links are \emph{undersaturated}: that is, the expected demand is served (on average) within a signal cycle. To avoid link saturation, we therefore pose the following convex optimization problem to determine minimum feasible actuation time $\Lambda^*$ (as suggested in \cite{MaxPressureStochastic}):
\begin{equation} \label{sum_lambda}
\begin{aligned}
\Lambda ^{*} = & \min_{\lambda = \{\lambda_S\}}
& & \sum_{S\in U} \lambda_{S} \\
& \text{subject to}
& &  \lambda_{S} \geq \kappa_S\\
&&& f_{l}r(l,m) < \sum_{S}\lambda_{S} c(l,m)S(l,m)\\
%&&& \sum_{S} \lambda_{S} < 1
\end{aligned}
\end{equation}
where $\kappa_S \in [0,1] \; \forall S\in U$, and $\sum_S \kappa_S <1$. If $\Lambda^* > 1$, the demand is not feasible under the set of control constraints $\{\kappa_S\}$ for any length time step. If $\Lambda^* < 1$, then we can define a cycle length for which flow is admissible without link saturation. However, this cycle length $T$ must be significantly greater than $\Lambda^*$ to account for clearance times. If we define $L = \text{ceil}\big(\frac{R}{\Delta t} \cdot |U|\big)$ to be total \emph{lost time steps} per cycle, a feasible cycle length $T$ must satisfy the following condition: 
\begin{equation} T > \frac{L}{1-\Lambda^*} \label{minTime} \end{equation} 


%This is an obvious extension of the the linear program for a single intersection proposed by Allsop \cite{Allsop} and an implicit version of the formulation of Wong and Yang \cite{Wong}


\subsection*{Cycle-based controller formulation}

%\begin{itemize}
%\item 
%%each phase $S\in  U$ is allocated at least some pre-defined minimum time $\kappa_S$: 
%$\lambda_{S} \geq \kappa_S$
%\item 
%%the flow is feasible: 
%$f_{l}r_{l,m} < \sum_{S}\lambda_{S} c(l,m)S(l,m)$
%\item 
%%all of the cycle time is allocated: 
%$\sum_{S} \lambda_{S} = 1 - \frac{L}{T}$
%\end{itemize}

The cycle-based max pressure controller is a relaxed control matrix that is constructed as follows:
\begin{equation} \label{uc*}
u^{c*} = \sum_{S \in U}\lambda_{S}^{*}S
\end{equation} 
where 
\begin{align} \nonumber
\{ \lambda^*_S \} = \; & \underset{\lambda_{1},...,\lambda_{\vert U\vert}}{ \arg \max} & & \sum_{S \in U}\lambda_{S}\Big(\sum_{l,m} w(l,m)(t)c(l,m) S(l,m)\Big)  \\
\nonumber & \text{subject to}
\nonumber & &  \lambda_{S} \geq \kappa_s\\
&&&\sum_{S} \lambda_{S} \leq 1 - \tfrac{L}{T}  \label{distMP_LP}
\end{align}
Immediately before time step $t=nT$, the controller $u^{c*}$ uses feedback measurements $x(t)$ to select a relaxed control matrix $S^{r*}$ with components $\lambda_S^*$ that satisfy \eqref{distMP_LP}. This relaxed controller is then applied for the subsequent $T$ time steps $\{t, t+1, \ldots, t+T-1\}$ before the controller is updated. 

Note that this controller is modeled such that all phases in an intersection are simultaneously actuated at some proportion of their maximum flow capacity. This is not possible in practice, as many phases will have to make conflicting use of the same intersection resources. Hence individual phases $S$ will have to be actuated in series, with each having a duration corresponding to a number of ``time units'' that are equal to cycle proportions $\{\lambda_S T\cdot  \Delta t\}$. Feedback measurements will then be a measure of ``average'' cycle queue length acquired over a set of measurements spanning the previous cycle. 

This highlights a practical benefit of the cycle-based max pressure controller: because it can be implemented such that phases occur in a predictable order, a signal running cycle-based max pressure can be synchronized with neighboring controllers to enforce a ``green-wave progression'' designed to minimizing individual vehicle stoppage and delay for a prioritized movement. 


\subsection*{$\tau$-non updated controller}

Cycle max pressure enables the control to act at a slower time scale than the queue dynamics, as would be the case in a practical traffic application. Suppose that we are given the model dynamics $X(t)$ as in \eqref{entrydynamics}-\eqref{internaldynamics}, but the controller $S^*(t)$ can only be updated every $\tau$ model time steps (or once per \emph{cycle}). The ``$\tau$-non updated'' control sequence is therefore composed of control matrices repeated for at least $\tau$ model time steps: for a fixed cycle size $\tau$ and integer $n$, 
\begin{align} \nonumber
S(n\tau&+1)  = S(n\tau +2) = \ldots = S((n+1)\tau ) = S^*(n\tau +1) \\
&=  \arg\max\{\gamma(S)(X(n\tau +1 )) \vert S \in U\}  
 \label{CYCLE_CONTROLLER}
\end{align}
Physically, the controller that maximizes the pressure at time step $n\tau + 1$ is continuously applied until time step $(n + 1)\tau$.

\subsection*{Relaxed Max Pressure Controller}

Let $\tau \in \mathbb{N}$ be fixed, the number of time steps between two actuation of the controller
$\forall n \in \mathbb{N}$, 

\begin{align} \nonumber
S(n\tau&+1)   = \ldots = S((n+1)\tau ) = S^*(n\tau +1) \\
&=  \arg\max\{\gamma(S)(X(n\tau +1 )) \vert S \in U\}  \\
& =  \underset{\lambda_{1},...,\lambda_{\vert U\vert}}{ \arg \max}  \sum_{S \in \mathcal{U}}\lambda_{S}\Big(\sum_{l,m} w(l,m)(t)c(l,m) S(l,m)\Big)  \\
\nonumber  \text{subject to}\\
\nonumber    \lambda_{S} & \geq \kappa_s\\
 \sum_{S} \lambda_{S} &  = S^{r*} = \displaystyle\sum_{S \in \mathcal{U}}\lambda_{S}^{*}S \leq 1 - \tfrac{L}{T}  \label{distMP_LP} 
\end{align}





\subsection*{$\tau$-admissible flows}
We first prove that this set of $\tau$-admissible flows (demands that can be accommodated using $\tau$-non updated sequences) is in fact the same set of flows that is admissible under typical updated control sequences, defined in equation \eqref{feasible_demand}. 

\noindent Define the following sets:
\begin{itemize}
\item $U$ is the set of admissible control matrices as in \eqref{feasible_demand},
\item $U_{\mathbb{N}}$ is the set of control sequences $\{S(1), S(2) \ldots S(t) \ldots |  S(\cdot) \in U\} $ where elements are applied at consecutive time steps,
\item $U_{\tau\mathbb{N}}$ is the set of control sequences $\{S(1), S(1), \ldots ,  S(\tau + 1),S(\tau + 1), \ldots , S(n\tau + 1),S(n\tau + 1), \ldots |  S(\cdot) \in U\} $ where controls are updated only once every $\tau$ steps,
\item $conv(U) = \Big\{\lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t) | \{S(1), S(2), \ldots , \\ S(t), \ldots \}\in U_{\mathbb{N}} \Big\} $ 
\item $conv(U_\tau ) = \Big\{\lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t) | \{S(1), S(1), \ldots, \\ S(\tau + 1),S(\tau + 1), \ldots\}\in U_{\tau\mathbb{N}} \Big\} $ 
\end{itemize}
Obviously, $conv(U_{\tau}) \subset conv(U)$. But we can also show that $conv(U) \subset conv(U_{\tau})$:  

\noindent Suppose $M \in conv(U)$, so $\exists \{ S(1) \ldots S(t) \ldots \}$ such that $M = \lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t)$.
\begin{align*}
M &= \lim\inf_{T} \dfrac{1}{T}\sum_{t=1}^{T} S(t)= \lim\inf_{T} \dfrac{1}{\tau T}\sum_{t=1}^{\tau T}  \tilde{S}(t) \; \\ 
& \qquad \text{ with } \tilde{S} = \{S(1), \ldots, S(1), \ldots, S(t), \ldots, S(t), \ldots \} \\
&= \lim\inf_{T} \dfrac{1}{ T}\sum_{t=1}^{T}  \tilde{S}(t) \\
\end{align*}
Trivially, $\tilde{S }\in conv(U_\tau)$. Because $conv(U_{\tau})\subset conv(U)$ and $cont(U) \subset conv(U_{\tau})$, it must hold that $conv(U) = conv(U_{\tau})$.  This establishes Property \ref{equality_property}: 

\begin{Prop} \label{equality_property}
\begin{equation*} conv(U) = conv(U_{\tau}) \end{equation*}
\end{Prop}

This property implies that a $\tau$-non updated control sequence can accommodate the same set of flows as a control sequence updated at every time step. The equivalence becomes intuitive when one considers that our definition of feasible flows considers only the long-term average of demand and service rates: note that a $\tau$ control matrix in $\tilde S$ is simply the average of the corresponding $\tau$ matrices in $\overline S$, such that $M_{\tilde S} = M_{\overline S}$. Hence,
\begin{align}
f_{l} r(l,m) < c(l,m)M_{\overline{S} }(l,m) \implies \\ f_{l} r(l,m) < c(l,m)M_{\tilde{S} }(l,m). \nonumber
\end{align}
However, as we will show in the following sections, the bound on queue lengths when the cycle controller is applied will be larger than in the immediate feedback setting.
%, which immediately seems counterintuitive. However, note that our current model framework assumes infinite link buffer capacities. With the $\tau$-non updated controller, instantaneous link queues will be higher but the same \emph{long-term average} service rates can be achieved -- and thus by our definition, this flow can be equally accommodated by either controller type. 
%We have shown that the same flows are ``admissible'' when control sequences updated only every $\tau$ time steps as when they are updated every time step. 
%During a single time step, the average flow arriving at queue $(l,m)$ is $f_{l}r(l,m)$ and the maximum number of vehicles capable of leaving is $c(l,m) M(l,m)$. Similarly, the average flow arriving between time steps $t$ and $t+\tau$ is $\tau f_{l} r(l,m) $, and the number of vehicles capable of leaving is $\tau c(l,m) M(l,m)$. So if a flow is admissible using an updated control sequence $\overline S$%with average service $M_{\overline S}$
%, it can be similarly accommodated with a non-updated sequence $\tilde S$, where each consecutive set of






\subsection*{Stability of the new controller}



Here we extend the previous proof of stability of an immediate feedback max pressure controller to the case of our relaxed max pressure controller.
We begin by defining two sets we gonna use later.

Define $conv_{\kappa}$ as the set of convex combinations of control matrices with coefficients larger than $\kappa$:
\begin{equation}
conv_{\kappa} = \Big\{ \sum_{S}\lambda_{S}S \big| \; \lambda_S > \kappa_S \; \forall S\in U\Big\}
\end{equation}
Also define a set of reduced admissible demands $D_{\kappa}$ which can in average be served in a single cycle with a relaxed control matrix that maintains the minimum time allocation for a given cycle time (as in \eqref{sum_lambda}):
\begin{align} \nonumber
d \in D_{\kappa} \; & \text{iff} \; \exists \; S^r \in conv_{\kappa} \; \\ & \text{such that} \; f_{l}r(l,m) < c(l,m)S^r(l,m)
\label{admissible_relaxed}
\end{align} 

\vspace{0.5cm}


\begin{Thm}\label{stabRelaxMP}
The relaxed max pressure controller, defined above, updated every $\tau$ iterations stabilizes the network whenever the demand is within a set of feasible demands $D^{\kappa}$.
\end{Thm}

\begin{proof}



%
%\subsubsection*{Immediate feedback Max Pressure: proof of Theorem 3}
%\input{appendix_immediatefeedbackproof}
\subsubsection*{Allocated Max Pressure: proof of Theorem 6}
\input{appendix_distributedproof}
\subsubsection*{Cycle Max Pressure: proof of Theorem 5}
\input{appendix_cycleproof}



\begin{align} \label{CYCLE_BOUNDS}
\dfrac{1}{\tau T} \displaystyle\sum_{t=1}^{\tau T} \expectation{\vert X(t)}< \dfrac{1}{2\varepsilon\eta\tau T}& \expectation{\vert X(1) \vert^{2}} \\ \nonumber
& + \dfrac{1}{2\varepsilon\eta\tau}\displaystyle\sum_{p=0}^{\tau - 1} (B(p) + \tau K)
\end{align}

where $\varepsilon$, $\eta$ and $K$ are constants which depend on network topology and demand.

\end{proof}

The proof above shows that the system is stable.




\subsection*{Stability of allocated max pressure}

We now show that the allocated max pressure controller $S^{r*}$ is stable in the sense of \eqref{stability_sufficient} under conditions slightly modified from those assumed in the stability proofs of immediate feedback and cycle max pressure.



%%%%%%%%%%%%%%%%%%%%%%%%
%cycle allocated MP
%%%%%%%%%%%%%%%%%%%%%%%%


%\subsection*{Definition}
%
%We now combine the cycle max pressure and allocated max pressure: once every $\tau$ model time steps, a relaxed controller $S^r$ is chosen and then applied at each of the subsequent $\tau$ time steps. In other words, a single relaxed controller $S^r(t)$ is applied for the set of time steps $\{t+1, t+2, \ldots, t+\tau -1 \}$. Then, at time $t+\tau$, a new relaxed controller $S^r (\tau)$ is calculated to be applied at $\{t+\tau+1, \ldots, t+2\tau -1 \}$. 
%
%\subsection*{Stability of cycle-allocated max pressure}
%\begin{Thm}\label{StabCycleDistributedMP}
%The sequence of cycle-allocated max pressure controller stabilizes the network
% whenever the average demand vector $d = \lbrace d_{l}\rbrace$ is within the set of feasible demands
%$ D_{\kappa}$ defined above.
%%Under this condition, the quantity:
%%\begin{equation}
%%\dfrac{1}{T}\sum_{t=1}^{T}\expectation{\vert X(t) \vert}
%%\end{equation}
%%is bounded for any time horizon $T$.
%\end{Thm}
%
%\vspace{0.5cm}
%
%The stability of the cycle-allocated max pressure control follows from a logical combination of the stability proofs of cycle and allocated variations. Explicitly, the result for cycle max pressure in Appendix \ref{cycleproof} still holds in the case of a relaxed controller when one assumes that demand flow satisfies the modified cycle-by-cycle admissibility condition introduced for allocated max pressure in Section \ref{sec:distributed}. 



\subsection*{Increased bound on queue length}
Max pressure controllers that are only updated every $\tau$ model time steps will stabilize a network; however the resulting bound on the queues will be higher than in the immediate feedback setting. 
Comparing \eqref{IF_BOUNDS} and \eqref{CYCLE_BOUNDS}, note that the constants are increased by a factor of
\begin{equation}
\dfrac{1}{\varepsilon \tau} \sum_{p=1}^{\tau - 1} B(p) = \dfrac{1}{\varepsilon \tau}  \dfrac{\tau(\tau - 1)}{2}\cdot(\text{constant}) = \dfrac{\tau - 1}{2\varepsilon} \cdot(\text{constant})
\end{equation}
The relative cost to queue bounds is therefore linear in $\tau$. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%










